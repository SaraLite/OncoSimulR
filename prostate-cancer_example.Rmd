---
title: "OncoSimulR: Frequency-dependent fitness"
author:
- name: First Author
  affiliation: First Author's Affiliation
- name: Second Author
  affiliation: Second Author's Affiliation
  email: corresponding@author.com
package: packageName
output:
  BiocStyle::html_document:
    css: "./css/style.css"
    toc: true
    toc_float: true
    
classoption: a4paper
geometry: margin=3cm
fontsize: 12pt
abstract: |
  Description of your vignette
vignette: |
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# News and functions used

**Explicar por encima cosas nuevas (lo de la leyenda), los paquetes cargados y las funciones incorporadas**


```{r message = FALSE, warning = FALSE}

# Packages
library(OncoSimulR)
library(ggplot2)

# Set a seed to oncoSimulIndiv 
set.seed(1)

# Set a seed to oncoSimulPop to allow reproducibility
library(parallel)
RNGkind("L'Ecuyer-CMRG")

# get rid of the messages
options(stringsAsFactors = FALSE)

# Functions
simul_boxplot2 <- function(df) {
  e <- ggplot(df, aes(x = Genotype, y = N))
  e + geom_boxplot(aes(fill = Genotype)) +
    stat_summary(fun.y = mean, geom = "point",
                 shape = 18, size = 2.5, color = "#FC4E07") 
}

compositionPop2 <- function(objPop) {
  clon_labels <- c("WT", objPop[[1]]$geneNames)
  listPop <- sapply(objPop, function(x) tail(x[[1]], 1)[1, -1])
  dfPop <- data.frame("Genotype" = rep(clon_labels, length(listPop)/length(clon_labels)),
                      "N" = c(listPop))
  simul_boxplot2(dfPop)
}

```

# Prostate cancer tumour–stroma interactions 

This example is based on the paper _Investigating prostate cancer tumour–stroma_
_interactions: clinical and biological insights from an evolutionary game_ 
(**referencia**) available at <http://dx.doi.org/10.1038/bjc.2011.517>. 
The authors apply an Evolutionary Game Theory to modelling the behavior and
progression of a prostate tumor formed by three different cell populations: 
stromal cells, a dependant tumour phenotype capable of co-opting stromal cells
to support its growth and an independent tumour phenotype that does not require
microenvironmental support, be it stromal associated or not. To enable this, the
model has four variables, which is the minimun necessity to describe the
relationships in terms of costs and benefits between the different types of 
cells and, of course, to describe the progression of the cancer. 

The different cell types, hence, are as follows:

1. S: stromal cells.  
2. D: microenvironmental-dependent tumour cells.   
3. I: microenvironmental-independent tumour cells. 

And the parameters that describe the relationships are as follows: 

* $\alpha$: benefit derived from the cooperation between a S cell and a D cell.  
* $\beta$: cost of extracting resources from the microenvironment.  
* $\gamma$: cost of being microenvironmentally independent.  
* $\rho$: benefit derived by D from paracrine growth factors produced by I cells. 

Table  \@ref(tab:table) shows the playoffs for each cell type when interacting 
with others. It is noted that in this model no other phenotypes are relevant in 
the context of the game and spatial considerations will not affect the outcome.

.     | S                  |    D       | I
-     | ------------------ | ---------- | --------------------
**S** | $0$                | $\alpha$   | $0$
**D** | $1+\alpha-\beta$   | $1-2\beta$ | $1-\beta+\rho$
**I** | $1-\gamma$         | $1-\gamma$ | $1-\gamma$

: (\#tab:table) Playoff table that represents the interactions between 
the three cell types considered in de model

The I cells are relatively independent from the microenvironment and 
produce their own growth factors (e.g. testosterone) and thus are
considered to have a comparatively constant fitness $(1-\gamma)$, where
$\gamma$ represents the fitness cost for I cells to be independent. The
D cells rely more on their microenvironment for survival and growth at 
a fitness cost $(\beta)$ that represents the scarcity of resources or 
space that I cells can procure themselves. A resource-poor microenvironment 
would then be characterised by a higher value of $\beta$. As I cells produce
space and shareable growth factors, this model assumes that D cells derive
a fitness advantage from their interactions with I cells represented by
the variable $\rho$. On the other hand, D cells interacting with other D
cells will have a harder time sharing existing microenvironmental resources
with other equally dependant cells and thus are assumed to have double the
cost $2\beta$ for relying on the microenvironment for survival and growth 
and thus have a fitness of $1–2\beta$. The S cells can interact with tumour 
cells. In a normal situation, this population are relatively growth quiescent 
with low rates of proliferation and death. For this reason the fitness
benefit derived by stromal cells from the interactions with tumour cells 
is assumed to be zero. However, they are able to undergo rapid proliferation
and produce growth factors if they are stimulated by factors produced by
I cells, giving rise to a mutualistic relationship. This relationship is 
represented by the parameter $\alpha$. A low $\alpha$ represents tumours 
in which the stroma cannot be co-opted and vice versa. 

From these variables, the fitness of each cell population
$(W\left(S\right), W\left(I\right), W\left(D\right))$ is as follows: 

<br>
\begin{equation}
  W\left(S\right) = 1 + f_3\alpha
  (\#eq:fitnessS)
\end{equation}
<br>
\begin{equation}
  W\left(I\right) = 2 - \gamma
  (\#eq:fitnessI)
\end{equation}
<br>
\begin{equation}
  W\left(D\right) = 1 + \left(1 - f_2 - f_3\right)\left(1 - \beta + \alpha\right) +\\
    f_2\left(1 - \beta + \rho\right) + f_3(1 - 2\beta) + \\
    1 - \beta + \alpha + f_2\left(\rho - \alpha\right) - f_3\left(\beta + \alpha\right)
  (\#eq:fitnessD)
\end{equation}
<br>

Where $f_2$ is the frequency of I cells and $f_3$ is the
frequency of D cells at a given time. All fitness equation
start from balance by the sum of 1. 

## Simulations

First, we define the fitness of the different genotypes (see Equations 
\@ref(eq:fitnessS),  \@ref(eq:fitnessI) and \@ref(eq:fitnessD)) through 
the function _fitness_rel_ that builds a data frame. 

It is important to note that this program models a situation where,
from a WT cell population, the rest of the cell population types 
are formed. However, this model has also stromal cells that are not
formed from a WT, since they are not tumour cells although 
interacting with it. Hence, for this model, we can not represent 
scenarios with total biological accuracy, something that we must
consider when interpreting the results. 

```{r exampleN_fitness}

fitness_rel <- function(a, b, r, g, gt = c("WT", "S", "I", "D")) {
    data.frame(
      Genotype = gt,
      Fitness = c("1",
                  paste0("1 + ", a, " * f_3"),
                  paste0("1 + 1 - ", g),
                  paste0("1 + (1 - f_2 - f_3) * (1 - ", b, " + ", 
                         a, ") + f_2 * (1 - ", b, " + ", r,
                         ") + f_3 * (1 - 2 * ", b, ") + 1 - ", b, 
                         " + ", a, " + f_2 * (", r, " - ",
                         a, ") - f_3 * (", b, " + ", a, ")")
                    )
             )
}

```


Then, we are going to model different scenarios that represent different
biological situations. In this case, we are going to explain 
four possible situations.

**Note:** For these simulations the values of paratemers are normalised
in the range (0 : 1) so 1 represents the maximum value for any parameter
being positive of negative to fitness depending on the parameter. 


### First scenario

In this simulation, we are modelling a situation where the environment
is relatively resource-poor. Besides, we set a intermediate cooperation between
D-D and D-I and a very low benefit from coexistence of D with I. 

* $\alpha$ (a) = 0.5: intermediate cooperation between D and D cells.
* $\beta$ (b) = 0.7: relatively resource-poor microenvironment.
* $\rho$ (p) = 0.1: low benefit of D cells.
* $\gamma$ (g) = 0.8: high cost of independence of I cells.  

We can observe that high values of $\alpha$ and low values of $\rho$ are 
translated in a larger profit of D cells from his interaction with S cells
than from his interaction with I cells. Besides, because of the high cost of 
independence of I cells ($\gamma$), it is not surprise that this population 
ends up becoming extinct. Finally, the tumour is composed by two cellular 
types: D and S cells. 

```{r exampleNscen1, message = FALSE, warning = FALSE}

scen1 <- allFitnessEffects(genotFitness = fitness_rel(a = 0.5, b = 0.7,
                                                     r = 0.1, g = 0.8),
                          frequencyDependentFitness = TRUE,
                          frequencyType = "rel")

simulScen1 <- oncoSimulIndiv(scen1,
                              model = "McFL",
                              onlyCancer = FALSE,
                              finalTime = 150,
                              mu = 1e-4,
                              initSize = 40000,
                              keepPhylog = TRUE,
                              seed = NULL,
                              errorHitMaxTries = FALSE,
                              errorHitWallTime = FALSE)

plot(simulScen1, show = "genotypes", type = "line", legend.ncols = 2)

```

In order to know the composition of the cell populations if we execute 
the model several times and the stability of the results, we build the next
boxplot with _compositionPop_ function after execute _oncoSimulPop_
with N = 20. We can observe that the median of D and S cells are clearly
greater than I cells in most simulations, so the results are stable.

```{r exampleNscenPop1}

simulScen1Pop <- oncoSimulPop(10,
                              scen1,
                              model = "McFL",
                              onlyCancer = FALSE,
                              mc.cores = 8,
                              finalTime = 150,
                              mu = 1e-4,
                              initSize = 4000,
                              keepPhylog = TRUE,
                              seed = NULL,
                              errorHitMaxTries = FALSE,
                              errorHitWallTime = FALSE)

compositionPop2(simulScen1Pop)

```


### Second scenario

In this case, we set $\alpha$ lower than in the first scenario and we 
enable the indepenence of I cells through a lower $\gamma$. 

* $\alpha$ (a) = 0.3: low cooperation between D cells.  
* $\beta$ (b) = 0.7: relatively resource-poor microenvironment.
* $\rho$ (r) = 0.1: low benefit of D cells from coexisting with I cells.
* $\gamma$ (g) = 0.7: lower cost of independence of I cells than in the 
first scenario. 

Because of we are easing the possibility of independence of I 
cells, instead of extinguishing as in the first scenario, they
compose the bulk of the tumour along with D cells in spite of 
the low benefit of cooperation between them (low $\rho$). 
Besides, we can observe that the population of I cells is 
bigger than the population of D cells, being at the end of
the simulation in balance. On the other hand, stromal cells 
drop at the beginning of the simulation.

```{r exampleNscen2, message = FALSE, warning = FALSE}

scen2 <- allFitnessEffects(genotFitness = fitness_rel(a = 0.3, b = 0.7,
                                                     r = 0.1, g = 0.7),
                          frequencyDependentFitness = TRUE,
                          frequencyType = "rel")

simulScen2 <- oncoSimulIndiv(scen2,
                              model = "McFL",
                              onlyCancer = FALSE,
                              finalTime = 150,
                              mu = 1e-4,
                              initSize = 4000,
                              keepPhylog = TRUE,
                              seed = NULL,
                              errorHitMaxTries = FALSE,
                              errorHitWallTime = FALSE)

plot(simulScen2, show = "genotypes", type = "line", legend.ncols = 2)

```

About the composition of the populations, if we simulate the
model 20 times, we can obverve that the results are stable
with the previous plot, highlighting the fact that the 
population of I cells is always greater than the population 
of D cells.

```{r exampleNscenPop2}

simulScen2Pop <- oncoSimulPop(10,
                              scen2,
                              model = "McFL",
                              onlyCancer = FALSE,
                              mc.cores = 8,
                              finalTime = 150,
                              mu = 1e-4,
                              initSize = 4000,
                              keepPhylog = TRUE,
                              seed = NULL,
                              errorHitMaxTries = FALSE,
                              errorHitWallTime = FALSE)

compositionPop2(simulScen2Pop)

```


### Third scenario

In this case, we have a extreme situation where the microenvironment is 
rich (high $\beta$) and the independence costs are very low ($\gamma$)
in relation with the previous scenarios.

* $\alpha$ (a) = 0.2: low cooperation between D cells. 
* $\beta$ (b) = 0.35: rich microenvironment, being beneficial for D cells.
* $\rho$ (r) = 0.1: low benefit of D cells from coexisting with I cells.
* $\gamma$ (g) = 0.3: independence costs very low, being beneficial for
I cells. 

Although $\gamma$ and $\rho$ are very low, which could make us think that 
I cells will control the tumour, we can observe that the fact that the 
microenvironment is very rich (with a low value of $\beta$) allows to 
D cells lead the progression  of the tumour over the rest of cell
populations, including I cells.

```{r exampleNscen3, message = FALSE, warning = FALSE}

scen3 <- allFitnessEffects(genotFitness = fitness_rel(a = 0.2, b = 0.30,
                                                     r = 0.1, g = 0.3),
                          frequencyDependentFitness = TRUE,
                          frequencyType = "rel")

simulScen3 <- oncoSimulIndiv(scen3,
                              model = "McFL",
                              onlyCancer = FALSE,
                              finalTime = 100,
                              mu = 1e-4,
                              initSize = 4000,
                              keepPhylog = TRUE,
                              seed = NULL,
                              errorHitMaxTries = FALSE,
                              errorHitWallTime = FALSE)

plot(simulScen3, show = "genotypes", type = "line")

```

About the composition of populations, we can observe that the results 
are stable, showing that D cell population is bigger than the rest 
of cell populations.

```{r exampleNscenPop3}

simulScen3Pop <- oncoSimulPop(10,
                              scen3,
                              model = "McFL",
                              onlyCancer = FALSE,
                              mc.cores = 8,
                              finalTime = 150,
                              mu = 1e-3,
                              initSize = 4000,
                              keepPhylog = TRUE,
                              seed = NULL,
                              errorHitMaxTries = FALSE,
                              errorHitWallTime = FALSE)

compositionPop2(simulScen3Pop)

```

### Fourth scenario

This is a variation of the third scenario to illustrate that, if 
we set a microenvironment more rich than in the previous scenario, 
we get a cooperation between D and I cells, although we can still observe 
the superiority of D cells over I cells.

```{r exampleNscen4, message = FALSE, warning = FALSE}

scen4 <- allFitnessEffects(genotFitness = fitness_rel(a = 0.2, b = 0.4,
                                                     r = 0.1, g = 0.3),
                          frequencyDependentFitness = TRUE,
                          frequencyType = "rel")

## Set a different seed to show the results better since
## with set.seed(1) the progression of I cells was not shown
set.seed(2)

simulScen4 <- oncoSimulIndiv(scen4,
                              model = "McFL",
                              onlyCancer = FALSE,
                              finalTime = 100,
                              mu = 1e-4,
                              initSize = 4000,
                              keepPhylog = TRUE,
                              seed = NULL,
                              errorHitMaxTries = FALSE,
                              errorHitWallTime = FALSE)

plot(simulScen4, show = "genotypes", type = "line", legend.ncols = 2)

```

In this case, we can see that there is more variation in the size of
population of I cells. There are cases where the I cell population
cooperates with D cells and, in others, there is not cooperation. 

```{r exampleNscenPop4}

simulScen4Pop <- oncoSimulPop(10,
                              scen4,
                              model = "McFL",
                              onlyCancer = FALSE,
                              mc.cores = 8,
                              finalTime = 150,
                              mu = 1e-3,
                              initSize = 4000,
                              keepPhylog = TRUE,
                              seed = NULL,
                              errorHitMaxTries = FALSE,
                              errorHitWallTime = FALSE)

compositionPop2(simulScen4Pop)

```





# Style macros

_BiocStyle_ introduces the following macros for referring to _R_ packages:

* `r Biocpkg("IRanges")`, for _Bioconductor_ software, annotation and experiment data packages,
* `r CRANpkg("data.table")`, for _R_ packages available on CRAN,
* `r Githubpkg("rstudio/rmarkdown")`, for _R_ packages available on GitHub,
* `r Rpackage("MyPkg")`, for _R_ packages that are _not_ available on _Bioconductor_, CRAN or GitHub.


# Figures

Assign captions to figures in the code chunk option `fig.cap` to automatically number them, and to be able to reference them, see Figure \@ref(fig:plot). The figure label is generated from the code chunk label by prefixing it with `fig:`.

```{r plot, fig.cap="Regular figure. The first sentence of the figure caption is automatically emphasized to serve as figure title.", echo=FALSE}
plot(cars)
```

Small and wide figures can be specified by `fig.small` and `fig.wide` code chunk options.

```{r small, fig.cap="Small figure. A plot produced by a code chunk with option `fig.small = TRUE`.", fig.small=TRUE, echo=FALSE}
plot(cars)
```

```{r wide, fig.cap="Wide figure. A plot produced by a code chunk with option `fig.wide = TRUE`.", fig.wide=TRUE, echo=FALSE}
plot(cars)
```


# Equations

To number and reference equations, put them in equation environments and assign labels to them, see Equation \@ref(eq:binom).

\begin{equation}
  f\left(k\right) = \binom{n}{k} p^k\left(1-p\right)^{n-k}
  (\#eq:binom)
\end{equation}


# Tables

Like figures, tables with captions will also be numbered and can be referenced, see Table \@ref(tab:table).

Fruit   | Price
------- | -----
bananas | 1.2
apples  | 1.0
oranges | 2.5

: (\#tab:table) A simple table. With caption.


# Cross-references

Apart from referencing figures (Section \@ref(figures)), tables (Section \@ref(tables)), and equations (Section \@ref(equations)), you can also use the same syntax to refer to sections by their default labels generated by pandoc.


# Side notes

Footnotes are displayed as side notes on the right margin^[this is a side note entered as a footnote], which has the advantage that they appear close to the place where they are defined.


# Session info {.unnumbered}

```{r sessionInfo, echo=FALSE}
sessionInfo()
```
