---
title: "Hawk and Dove"
output: html_document
---
<style>
body {
text-align: justify}
</style>
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Evolutionary games theory
```{r}
suppressPackageStartupMessages(library("OncoSimulR"))
suppressPackageStartupMessages(library("ggplot2"))

options(stringsAsFactors = FALSE)

simul_boxplot2 <- function(df) {
  e <- ggplot(df, aes(x = Genotype, y = N))
  e + geom_boxplot(aes(fill = Genotype)) +
    stat_summary(fun.y = mean, geom = "point",
                 shape = 18, size = 2.5, color = "#FC4E07")
}

compositionPop2 <- function(objPop) {
  clon_labels <- c("WT", objPop[[1]]$geneNames)
  listPop <- sapply(objPop, function(x) tail(x[[1]], 1)[1, -1])
  dfPop <- data.frame("Genotype" = rep(clon_labels, length(listPop)/length(clon_labels)),
                      "N" = c(listPop))
  simul_boxplot2(dfPop)
}
```

## Evolutionary games theory
The example we are going to show is one of the first games that Maynar Smith analyzed. This classic game is: Hawk and Dove (https://en.wikipedia.org/wiki/Chicken_(game))

In this game, the two competitors are subtypes of the same species but with different strategies.  The Hawk first displays aggression, then escalates into a fight until it either wins or is injured (loses). The Dove first displays aggression, but if faced with major escalation runs for safety. If not faced with such escalation, the Dove attempts to share the resource.

![Payoff Matrix for Hawk Dove Game](.\Images_markdown\Hawk_Dove_payoff.PNG)

Given that the resource is given the value V, the damage from losing a fight is given cost C:[1]

- If a Hawk meets a Dove he gets the full resource V to himself
- If a Hawk meets a Hawk – half the time he wins, half the time he loses...so his average outcome is then V/2 minus C/2
- If a Dove meets a Hawk he will back off and get nothing – 0
- If a Dove meets a Dove both share the resource and get V/2

The actual payoff however depends on the probability of meeting a Hawk or Dove, which in turn is a representation of the percentage of Hawks and Doves in the population when a particular contest takes place. That in turn is determined by the results of all of the previous contests. If the cost of losing C is greater than the value of winning V (the normal situation in the natural world) the mathematics ends in an stationary point (ESS), a mix of the two strategies where the population of Hawks is V/C.

In this case we assume a stable equilibrium in the population dynamics, that is, although there are external variations in the model, it recovers and returns to equilibrium (as shown in the image below).

![Stable equilibrium](.\Images_markdown\Stable_equilibrium.jpg)

We are going to simulate with OncoSimulR the situation in which the cost of losing C is greater than the value of gaining V (C = 10, V = 2). Before performing the simulation, let's look at the fitness of each competitor.

```{r, message=F}
## Stablish Genotype-Fitnees mapping. D = Dove, H = Hawk
H_D_fitness <- function(c, v,
                    gt = c("WT", "H", "D")) {
  data.frame(Genotype = gt,
             Fitness = c(
               paste0("1"),
               paste0("1 + f_1 *", (v-c)/2, "+ f_2 *", v),
               paste0("1 + f_2 *", v/2)))
}

## Fitness Effects specification
HD_competition <-allFitnessEffects(
  genotFitness = H_D_fitness(10, 2, 
                         gt = c("WT", "H", "D")),
  frequencyDependentFitness = TRUE,
  frequencyType = "rel",
  spPopSizes = c(5000, 5000, 5000))

## Plot fitness landscape of genotype "H, D" evaluation
data.frame("Doves_fitness" = evalGenotype(genotype = "D", fitnessEffects = HD_competition), 
           "Hawks_fitness" = evalGenotype(genotype = "H", fitnessEffects = HD_competition)) 
```

We observe that the penalty of fighting (C > V) benefits the dove in terms of fitness respect to the hawk. 

``` {r, message=F}
options(stringsAsFactors = FALSE)
## Simulated trajectories
simulation <- oncoSimulPop(2,
                           mc.cores = 6,
                           HD_competition,
                           model = "McFL", # There is no collapse
                           onlyCancer = FALSE,
                           finalTime = 500,
                           mu = 1e-2, # Quick emergence of D and H
                           initSize = 4000,
                           keepPhylog = TRUE,
                           seed = NULL,
                           errorHitMaxTries = FALSE,
                           errorHitWallTime = FALSE)

## Plot first trajectory as an example
plot(simulation[[1]], show = "genotypes", type = "line", xlim = c(40, 500))

## Agreement: Show boxplot from several simulations. 
compositionPop2(simulation)
```

As mentioned above, mathematically when a stationary point (ESS) is reached the relative frequency of hawks is V/C and doves 1-(V/C). Considering f_H as relative frecuency of hawks and f_D = 1-f_H as frequency of doves:
Hawk:
1 + f_H*(v-c)/2 + (1-f_H)*v

Dove:
1 + (1-f_H)*v/2

Hawk = Dove: 
1 + f_H*(v-c)/2 + (1-f_H)*v = 1 + (1-f_H)*v/2 

Resolving for f_H:
f_H = V/C

Therefore, the relative frequency of hawks in equilibrium is equal to V/C. In our case it would be 20% (C = 10, V = 2). Let's check it:

```{r}
## Recover the final result from first simulation
result <- tail(simulation[[1]][[1]], 1)

## Get the number of organisms from each species
n_WT <- result[2]
n_D <- result[3]
n_H <- result[4]
total <- n_WT + n_D + n_H

## Dove percentage
data.frame("Doves" = round(n_D/total, 2)*100, "Hawks" = round(n_H/total, 2)*100  )
```
To sum up, this example shows that when the risks of contest injury or death (the Cost C) is significantly greater than the potential reward (the benefit value V), the stable population will be mixed between aggressors and doves, and the proportion of doves will exceed that of the aggressors. This explains behaviours observed in nature.